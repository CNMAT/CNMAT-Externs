<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 4.01 Transitional//EN">
<html>
	<head>
		<meta http-equiv="Content-Type" content="text/html;charset=UTF-8">
		<title>Max5 API Reference</title>
		<link href="c74-doxygen.css" rel="stylesheet" type="text/css">
	</head>
	<body>

		<div id="c74header">
			<img src="max5.png" />
			<p>Max 5 API Reference</p>
		</div>

<!-- Generated by Doxygen 1.6.1 -->
<script type="text/javascript">
<!--
function changeDisplayState (e){
  var num=this.id.replace(/[^[0-9]/g,'');
  var button=this.firstChild;
  var sectionDiv=document.getElementById('dynsection'+num);
  if (sectionDiv.style.display=='none'||sectionDiv.style.display==''){
    sectionDiv.style.display='block';
    button.src='open.gif';
  }else{
    sectionDiv.style.display='none';
    button.src='closed.gif';
  }
}
function initDynSections(){
  var divs=document.getElementsByTagName('div');
  var sectionCounter=1;
  for(var i=0;i<divs.length-1;i++){
    if(divs[i].className=='dynheader'&&divs[i+1].className=='dynsection'){
      var header=divs[i];
      var section=divs[i+1];
      var button=header.firstChild;
      if (button!='IMG'){
        divs[i].insertBefore(document.createTextNode(' '),divs[i].firstChild);
        button=document.createElement('img');
        divs[i].insertBefore(button,divs[i].firstChild);
      }
      header.style.cursor='pointer';
      header.onclick=changeDisplayState;
      header.id='dynheader'+sectionCounter;
      button.src='closed.gif';
      section.id='dynsection'+sectionCounter;
      section.style.display='none';
      section.style.marginLeft='14px';
      sectionCounter++;
    }
  }
}
window.onload = initDynSections;
-->
</script>
<div class="navigation" id="top">
  <div class="tabs">
    <ul>
      <li><a href="main.html"><span>Main&nbsp;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&nbsp;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&nbsp;Structures</span></a></li>
    </ul>
  </div>
</div>
<div class="contents">


<h1><a class="anchor" id="chapter_msp_anatomy">Anatomy of a MSP Object </a></h1><p>An MSP object that handles audio signals is a regular Max object with a few extras.</p>
<p>Refer to the <a href="simplemsp~_8c-source.html">simplemsp~</a> example project source as we detail these additions. simplemsp~ is simply an object that adds a number to a signal, identical in function to the regular MSP +~ object if you were to give it an argument of 1.</p>
<p>Here is an enumeration of the basic tasks:</p>
<p>1) additional header files</p>
<p>After including ext.h and ext_obex.h, include z_dsp.h </p>
<div class="fragment"><pre class="fragment"><span class="preprocessor">    #include &quot;z_dsp.h&quot;</span>
</pre></div><p>2) C structure declaration</p>
<p>The C structure declaration must begin with a <a class="el" href="structt__pxobject.html" title="Header for any non-ui signal processing object.">t_pxobject</a>, not a <a class="el" href="structt__object.html" title="The structure for the head of any object which wants to have inlets or outlets, or...">t_object</a>: </p>
<div class="fragment"><pre class="fragment">    <span class="keyword">typedef</span> <span class="keyword">struct </span>_mydspobject
    {
        <a class="code" href="structt__pxobject.html" title="Header for any non-ui signal processing object.">t_pxobject</a> m_obj;
        <span class="comment">// rest of the structure&apos;s fields</span>
    } t_mydspobject;
</pre></div><p>3) initialization routine</p>
<p>When creating the class with <a class="el" href="group__class.html#ga238696d466081965c2b72b3880358404" title="Initializes a class by informing Max of its name, instance creation and free functions...">class_new()</a>, you must have a free function. If you have nothing special to do, use <a class="el" href="group__msp.html#ga9a981adf6eea7e55d11c1a0b02592a6e" title="This is commonly used rather than directly calling z_dsp_free() in MSP objects.">dsp_free()</a>, which is defined for this purpose. If you write your own free function, the first thing it should do is call <a class="el" href="group__msp.html#ga9a981adf6eea7e55d11c1a0b02592a6e" title="This is commonly used rather than directly calling z_dsp_free() in MSP objects.">dsp_free()</a>. This is essential to avoid crashes when freeing your object when audio processing is turned on. </p>
<div class="fragment"><pre class="fragment">        c = <a class="code" href="group__class.html#ga238696d466081965c2b72b3880358404" title="Initializes a class by informing Max of its name, instance creation and free functions...">class_new</a>(<span class="stringliteral">&quot;mydspobject&quot;</span>, (<a class="code" href="group__datatypes.html#gac26ba0a173b50597f5738132e059b42d" title="Function pointer type for generic methods.">method</a>)mydspobject_new, (<a class="code" href="group__datatypes.html#gac26ba0a173b50597f5738132e059b42d" title="Function pointer type for generic methods.">method</a>)<a class="code" href="group__msp.html#ga9a981adf6eea7e55d11c1a0b02592a6e" title="This is commonly used rather than directly calling z_dsp_free() in MSP objects.">dsp_free</a>, <span class="keyword">sizeof</span>(t_mydspobject), NULL, 0);
</pre></div><p>After creating your class with <a class="el" href="group__class.html#ga238696d466081965c2b72b3880358404" title="Initializes a class by informing Max of its name, instance creation and free functions...">class_new()</a>, you must call <a class="el" href="group__msp.html#ga7427ae73a2ad71a1b4ef1bee2fd432fc" title="This routine must be called in your object&#39;s initialization routine.">class_dspinit()</a>, which will add some standard method handlers for internal messages used by all signal objects. </p>
<div class="fragment"><pre class="fragment">        <a class="code" href="group__msp.html#ga7427ae73a2ad71a1b4ef1bee2fd432fc" title="This routine must be called in your object&amp;#39;s initialization routine.">class_dspinit</a>(c);
</pre></div><p>Your signal object needs a method that is bound to the symbol "dsp" -- we'll detail what this method does below, but the following line needs to be added while initializing the class: </p>
<div class="fragment"><pre class="fragment">        <a class="code" href="group__class.html#ga1fabf54e0cec8d4e5f732fa347b3f874" title="Adds a method to a previously defined object class.">class_addmethod</a>(c, (<a class="code" href="group__datatypes.html#gac26ba0a173b50597f5738132e059b42d" title="Function pointer type for generic methods.">method</a>)mydspobject_dsp, <span class="stringliteral">&quot;dsp&quot;</span>, <a class="code" href="group__atom.html#gga8aa6700e9f00b132eb376db6e39ade47af48193ec36e53b1507d81c49873c8d7a" title="cannot typecheck args">A_CANT</a>, 0);
</pre></div><p>4) new instance routine</p>
<p>The new instance routine must call <a class="el" href="group__msp.html#gad15f054306792846a00a5f4e9e5426be" title="This is commonly used rather than directly calling z_dsp_setup() in MSP objects.">dsp_setup()</a>, passing a pointer to the newly allocated object pointer plus a number of signal inlets the object will have. If the object has no signal inlets, you may pass 0. The <a href="simplemsp~_8c-source.html">simplemsp~</a> object (as an example) has a single signal inlet: </p>
<div class="fragment"><pre class="fragment">        <a class="code" href="group__msp.html#gad15f054306792846a00a5f4e9e5426be" title="This is commonly used rather than directly calling z_dsp_setup() in MSP objects.">dsp_setup</a>((<a class="code" href="structt__pxobject.html" title="Header for any non-ui signal processing object.">t_pxobject</a> *)x, 1);
</pre></div><p><a class="el" href="group__msp.html#gad15f054306792846a00a5f4e9e5426be" title="This is commonly used rather than directly calling z_dsp_setup() in MSP objects.">dsp_setup()</a> will make the signal inlets (as proxies) so you need not make them yourself.</p>
<p>If your object will have audio signal outputs, they need to be created in the new instance routine with <a class="el" href="group__inout.html#ga451b3a1ec203ac8648a5399e209f070a" title="Use outlet_new() to create an outlet that can send a specific non-standard message...">outlet_new()</a>. However, you will never access them directly, so you don't need to store pointers to them as you do with regular outlets. Here is an example of creating two signal outlets: </p>
<div class="fragment"><pre class="fragment">        <a class="code" href="group__inout.html#ga451b3a1ec203ac8648a5399e209f070a" title="Use outlet_new() to create an outlet that can send a specific non-standard message...">outlet_new</a>((<a class="code" href="structt__object.html" title="The structure for the head of any object which wants to have inlets or outlets, or...">t_object</a> *)x, <span class="stringliteral">&quot;signal&quot;</span>);
        <a class="code" href="group__inout.html#ga451b3a1ec203ac8648a5399e209f070a" title="Use outlet_new() to create an outlet that can send a specific non-standard message...">outlet_new</a>((<a class="code" href="structt__object.html" title="The structure for the head of any object which wants to have inlets or outlets, or...">t_object</a> *)x, <span class="stringliteral">&quot;signal&quot;</span>);
</pre></div><p>5) The dsp method and perform routine</p>
<p>The dsp method specifies the signal processing function your object defines along with its arguments. Your object's dsp method will be called when the MSP signal compiler is building a sequence of operations (known as the DSP Chain) that will be performed on each set of audio samples. The operation sequence consists of a pointers to functions (called perform routines) followed by arguments to those functions.</p>
<p>The dsp method is declared as follows: </p>
<div class="fragment"><pre class="fragment">    <span class="keywordtype">void</span> mydspobject_dsp(t_mydspobject *x, <a class="code" href="structt__signal.html" title="The signal data structure.">t_signal</a> **sp, <span class="keywordtype">short</span> *count);
</pre></div><p>To add an entry to the DSP chain, your dsp method uses <a class="el" href="group__msp.html#gae9a75fa230b1db6d8316405d4a6065cc" title="Call this function in your MSP object&#39;s dsp method.">dsp_add()</a>. The dsp method is passed an array of signals (<a class="el" href="structt__signal.html" title="The signal data structure.">t_signal</a> pointers), which contain pointers to the actual sample memory your object's perform routine will be using for input and output. The array of signals starts with the inputs (from left to right), followed by the outputs. For example, if your object has two inputs (because your new instance routine called <a class="el" href="group__msp.html#gad15f054306792846a00a5f4e9e5426be" title="This is commonly used rather than directly calling z_dsp_setup() in MSP objects.">dsp_setup(x, 2)</a>) and three outputs (because your new instance created three signal outlets), the signal array sp would contain five items as follows: </p>
<div class="fragment"><pre class="fragment">    sp[0] <span class="comment">// left input</span>
    sp[1] <span class="comment">// right input</span>
    sp[2] <span class="comment">// left output</span>
    sp[3] <span class="comment">// middle output</span>
    sp[4] <span class="comment">// right output</span>
</pre></div><p>The <a class="el" href="structt__signal.html" title="The signal data structure.">t_signal</a> data structure (defined in z_dsp.h), contains two important elements: the s_n field, which is the size of the signal vector, and s_vec, which is a pointer to an array of 32-bit floats containing the signal data. All t_signals your object will receive have the same size. This size is not necessarily the same as the global MSP signal vector size, because your object might be inside a patcher within a poly~ object that defines its own size. Therefore it is important to use the s_n field of a signal passed to your object's dsp method.</p>
<p>You can use a variety of strategies to pass arguments to your perform routine via <a class="el" href="group__msp.html#gae9a75fa230b1db6d8316405d4a6065cc" title="Call this function in your MSP object&#39;s dsp method.">dsp_add()</a>. For simple unit generators that don't store any internal state between computing vectors, it is sufficient to pass the inputs, outputs, and vector size. For objects that need to store internal state between computing vectors such as filters or ramp generators, you will pass a pointer to your object, whose data structure should contain space to store this state. The plus1~ object does not need to store internal state. It passes the input, output, and vector size to its perform routine. The plus1~ dsp method is shown below:</p>
<div class="fragment"><pre class="fragment">    <span class="keywordtype">void</span> plus1_dsp(t_plus1 *x, <a class="code" href="structt__signal.html" title="The signal data structure.">t_signal</a> **sp, <span class="keywordtype">short</span> *count)
    {
        <a class="code" href="group__msp.html#gae9a75fa230b1db6d8316405d4a6065cc" title="Call this function in your MSP object&amp;#39;s dsp method.">dsp_add</a>(plus1_perform, 3, sp[0]-&gt;s_vec, sp[1]-&gt;s_vec, sp[0]-&gt;s_n);
    }
</pre></div><p>The first argument to <a class="el" href="group__msp.html#gae9a75fa230b1db6d8316405d4a6065cc" title="Call this function in your MSP object&#39;s dsp method.">dsp_add()</a> is your perform routine, followed by the number of additional arguments you wish to copy to the DSP chain, and then the arguments.</p>
<p>The perform routine is not a "method" in the traditional sense. It will be called within the callback of an audio driver, which, unless the user is employing the Non-Real Time audio driver, will typically be in a high-priority thread. Thread protection inside the perform routine is minimal. You can use a clock, but you cannot use qelems or outlets. The design of the perform routine is somewhat unlike other Max methods. It receives a pointer to a piece of the DSP chain and it is expected to return the location of the next perform routine on the chain. The next location is determined by the number of arguments you specified for your perform routine with your call to <a class="el" href="group__msp.html#gae9a75fa230b1db6d8316405d4a6065cc" title="Call this function in your MSP object&#39;s dsp method.">dsp_add()</a>. For example, if you will pass three arguments, you need to return w + 4.</p>
<p>Here is the plus1 perform routine:</p>
<div class="fragment"><pre class="fragment">    <a class="code" href="group__msp.html#gaaca420c8a41d33afb2f9e783ce6059e3" title="An integer.">t_int</a> *plus1_perform(<a class="code" href="group__msp.html#gaaca420c8a41d33afb2f9e783ce6059e3" title="An integer.">t_int</a> *w)
    {
        <a class="code" href="group__msp.html#gab68e234c9dccbd3d62659023db9f9486" title="A float.">t_float</a> *in, *out;
        <span class="keywordtype">int</span> n;

        in = (<a class="code" href="group__msp.html#gab68e234c9dccbd3d62659023db9f9486" title="A float.">t_float</a> *)w[1];       <span class="comment">// get input signal vector</span>
        out = (<a class="code" href="group__msp.html#gab68e234c9dccbd3d62659023db9f9486" title="A float.">t_float</a> *)w[2];      <span class="comment">// get output signal vector</span>
        n = (int)w[3];          <span class="comment">// vector size</span>

    
        <span class="keywordflow">while</span> (n--)         <span class="comment">// perform calculation on all samples</span>
            *out++ = *in++ + 1.;
    
        <span class="keywordflow">return</span> w + 4;           <span class="comment">// must return next DSP chain location</span>
    }
</pre></div><p>6) Free function</p>
<p>The free function for the class must either be <a class="el" href="group__msp.html#ga9a981adf6eea7e55d11c1a0b02592a6e" title="This is commonly used rather than directly calling z_dsp_free() in MSP objects.">dsp_free()</a> or it must be written to call <a class="el" href="group__msp.html#ga9a981adf6eea7e55d11c1a0b02592a6e" title="This is commonly used rather than directly calling z_dsp_free() in MSP objects.">dsp_free()</a> as shown in the example below:</p>
<div class="fragment"><pre class="fragment">    <span class="keywordtype">void</span> mydspobject_free(t_mydspobject *x)
    {
        <a class="code" href="group__msp.html#ga9a981adf6eea7e55d11c1a0b02592a6e" title="This is commonly used rather than directly calling z_dsp_free() in MSP objects.">dsp_free</a>((<a class="code" href="structt__pxobject.html" title="Header for any non-ui signal processing object.">t_pxobject</a> *)x);

        <span class="comment">// can do other stuff here</span>
    }
</pre></div> </div>
		<div id="c74footer">
			<p>Copyright &copy; 2008, <a href="http://www.cycling74.com/">Cycling '74</a></p>
		</div>
	</body>
</html>
