<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Max 6 API</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
	<div id="c74header">
		<img src="header.png" height="200" />
	</div>
</div>

<!-- Generated by Doxygen 1.7.5.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="dynsections.js"></script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('chapter_anatomy.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Anatomy of a Max Object </div>  </div>
</div>
<div class="contents">
<div class="textblock"><p>Max objects are written in the C language, and the Max API is C-based.</p>
<p>You could use C++ but we don't support it at the API level. Writing a Max object in C, you have five basic tasks:</p>
<p>1) including the right header files (usually ext.h and ext_obex.h)</p>
<p>2) declaring a C structure for your object</p>
<p>3) writing an initialization routine called main that defines the class</p>
<p>4) writing a new instance routine that creates a new instance of the class, when someone makes one or types its name into an object box</p>
<p>5) writing methods (or message handlers) that implement the behavior of the object</p>
<p>Let's look at each of these in more detail. It's useful to open the simplemax example project as we will be citing examples from it.</p>
<h2><a class="anchor" id="chapter_anatomy_includes"></a>
Include Files</h2>
<p>Most of the basic Max API is included in the files ext.h and ext_obex.h. These are essentially required for any object. Beyond this there are specific include files for more specialized objects.</p>
<p>The header files are cross-platform.</p>
<ul>
<li>jpatcher_api.h is required for any Max UI objects</li>
<li>z_dsp.h is required for MSP audio objects</li>
</ul>
<div class="fragment"><pre class="fragment"><span class="preprocessor">    #include &quot;ext.h&quot;</span> <span class="comment">// should always be first, followed by ext_obex.h and any other files.</span>
</pre></div><h2><a class="anchor" id="chapter_anatomy_object_decl"></a>
The Object Declaration</h2>
<p>Basic Max objects are declared as C structures. The first element of the structure is a <a class="el" href="structt__object.html" title="The structure for the head of any object which wants to have inlets or outlets, or support attributes...">t_object</a>, followed by whatever you want. The example below has one long structure member.</p>
<div class="fragment"><pre class="fragment">    <span class="keyword">typedef</span> <span class="keyword">struct </span>_simp
    {
        <a class="code" href="structt__object.html" title="The structure for the head of any object which wants to have inlets or outlets, or support attributes...">t_object</a> s_obj;     <span class="comment">// t_object header</span>
        <span class="keywordtype">long</span> s_value;       <span class="comment">// something else</span>
    } t_simp;
</pre></div><p>Your structure declaration will be used in the prototypes to functions you declare, so you'll need to place above these prototypes.</p>
<h2><a class="anchor" id="chapter_anatomy_object_init"></a>
Initialization Routine</h2>
<p>The initialization routine, which must be called main, is called when Max loads your object for the first time. In the initialization routine, you define one or more classes. Defining a class consists of the following:</p>
<p>1) telling Max about the size of your object's structure and how to create and destroy an instance 2) defining methods that implement the object's behavior 3) in some cases, defining attributes that describe the object's data 4) registering the class in a name space</p>
<p>Here is the simp class example initialization routine:</p>
<div class="fragment"><pre class="fragment">    <span class="keyword">static</span> <a class="code" href="structt__class.html" title="The data structure for a Max class.">t_class</a> *s_simp_class; <span class="comment">// global pointer to our class definition that is setup in main()</span>

    <span class="keywordtype">int</span> main()
    {
        <a class="code" href="structt__class.html" title="The data structure for a Max class.">t_class</a> *c;

        c = <a class="code" href="group__class.html#ga3450d7e28cb57dc3819486ff49f019c7" title="Initializes a class by informing Max of its name, instance creation and free functions, size and argument types.">class_new</a>(<span class="stringliteral">&quot;simp&quot;</span>, (<a class="code" href="group__datatypes.html#gac26ba0a173b50597f5738132e059b42d" title="Function pointer type for generic methods.">method</a>)simp_new, (<a class="code" href="group__datatypes.html#gac26ba0a173b50597f5738132e059b42d" title="Function pointer type for generic methods.">method</a>)NULL, <span class="keyword">sizeof</span>(t_simp), 0L, 0);   
        <a class="code" href="group__class.html#gaab2e3c25868317c8a9c216bbca2c040d" title="Adds a method to a previously defined object class.">class_addmethod</a>(c, (<a class="code" href="group__datatypes.html#gac26ba0a173b50597f5738132e059b42d" title="Function pointer type for generic methods.">method</a>)simp_int, <span class="stringliteral">&quot;int&quot;</span>, <a class="code" href="group__atom.html#gga8aa6700e9f00b132eb376db6e39ade47a002f28879581a6f66ea492b994b96f1e" title="long integer">A_LONG</a>, 0);
        <a class="code" href="group__class.html#gaab2e3c25868317c8a9c216bbca2c040d" title="Adds a method to a previously defined object class.">class_addmethod</a>(c, (<a class="code" href="group__datatypes.html#gac26ba0a173b50597f5738132e059b42d" title="Function pointer type for generic methods.">method</a>)simp_bang, <span class="stringliteral">&quot;bang&quot;</span>, 0);

        <a class="code" href="group__class.html#ga0709af4aad9570f0cb91711a5c6d34d1" title="Registers a previously defined object class.">class_register</a>(<a class="code" href="group__class.html#gaf640c99a1fceb8158c2d1e77381b0320" title="The namespace for all Max object classes which can be instantiated in a box, i.e.">CLASS_BOX</a>, c);

        s_simp_class = c;
    
        <span class="keywordflow">return</span> 0;
    }
</pre></div><p><a class="el" href="group__class.html#ga3450d7e28cb57dc3819486ff49f019c7" title="Initializes a class by informing Max of its name, instance creation and free functions, size and argument types.">class_new()</a> creates a class with the new instance routine (see below), a free function (in this case there isn't one, so we pass NULL), the size of the structure, a no-longer used argument, and then a description of the arguments you type when creating an instance (in this case, there are no arguments, so we pass 0).</p>
<p><a class="el" href="group__class.html#gaab2e3c25868317c8a9c216bbca2c040d" title="Adds a method to a previously defined object class.">class_addmethod()</a> binds a C function to a text symbol. The two methods defined here are int and bang.</p>
<p><a class="el" href="group__class.html#ga0709af4aad9570f0cb91711a5c6d34d1" title="Registers a previously defined object class.">class_register()</a> adds this class to the <a class="el" href="group__class.html#gaf640c99a1fceb8158c2d1e77381b0320" title="The namespace for all Max object classes which can be instantiated in a box, i.e.">CLASS_BOX</a> name space, meaning that it will be searched when a user tries to type it into a box.</p>
<p>Finally, we assign the class we've created to a global variable so we can use it when creating new instances.</p>
<p>More complex classes will declare more methods. In many cases, you'll declare methods to implement certain API features. This is particularly true for UI objects.</p>
<h2><a class="anchor" id="chapter_anatomy_object_new"></a>
New Instance Routine</h2>
<p>The standard new instance routine allocates the memory to create an instance of your class and then initializes this instance. It then returns a pointer to the newly created object.</p>
<p>Here is the simp new instance routine</p>
<div class="fragment"><pre class="fragment">    <span class="keywordtype">void</span> *simp_new()
    {
        t_simp *x = (t_simp *)<a class="code" href="group__obj.html#gacb89ef27c34b45e9037d877375804284" title="Allocates the memory for an instance of an object class and initialize its object header...">object_alloc</a>(s_simp_class);

        x-&gt;s_value = 0;

        <span class="keywordflow">return</span> x;
    }
</pre></div><p>The first line uses the global variable s_simp_class we defined in the initialization routine to create a new instance of the class. Essentially, the instance is a block of memory of the size defined by the class, along with a pointer to the class that permits us to dispatch messages correctly.</p>
<p>The next line initializes our data. More complex objects will do a lot more here, such as creating inlets and outlets. By default, the object being created will appear with one inlet and no outlets.</p>
<p>Finally, in the last line, we return a pointer to the newly created instance.</p>
<h2><a class="anchor" id="chapter_anatomy_object_mess_handlers"></a>
Message Handlers</h2>
<p>We are now ready to define some actual behavior for our object by writing C functions that will be called when our object is sent messages. For this simple example, we will write only two functions. simp_int will be called when our object receives numbers. It will store the received number in the s_value field. simp_bang will be called when our object receives a bang. It will print the value in the Max window. So, yes, this object is pretty useless!</p>
<p>The C functions you write will be declared according to the arguments the message requires. All functions are passed a pointer to your object as the first argument. For a function handling the int message, a single second argument that is a long is passed. For a function handling the bang message, no additional arguments are passed.</p>
<p>Here is the int method:</p>
<div class="fragment"><pre class="fragment">    <span class="keywordtype">void</span> simp_int(t_simp *x, <span class="keywordtype">long</span> n)
    {
        x-&gt;s_value = n;
    }
</pre></div><p>This simply copies the value of the argument to the internal storage within the instance.</p>
<p>Here is the bang method:</p>
<div class="fragment"><pre class="fragment">    <span class="keywordtype">void</span> simp_bang(t_simp *x)
    {
        <a class="code" href="group__console.html#ga8eebb1400d598f4423f925102d02970a" title="Print text to the Max window.">post</a>(<span class="stringliteral">&quot;value is %ld&quot;</span>,x-&gt;s_value);
    }
</pre></div><p>The <a class="el" href="group__console.html#ga8eebb1400d598f4423f925102d02970a" title="Print text to the Max window.">post()</a> function is similar to printf(), but puts the text in the Max window. <a class="el" href="group__console.html#ga8eebb1400d598f4423f925102d02970a" title="Print text to the Max window.">post()</a> is very helpful for debugging, particularly when you cannot stop user interaction or real-time computation to look at something in a debugger.</p>
<p>You can also add a float message, which is invoked when a floating-point number is sent to your object. Add the following to your initialization routine:</p>
<div class="fragment"><pre class="fragment">        <a class="code" href="group__class.html#gaab2e3c25868317c8a9c216bbca2c040d" title="Adds a method to a previously defined object class.">class_addmethod</a>(c, (<a class="code" href="group__datatypes.html#gac26ba0a173b50597f5738132e059b42d" title="Function pointer type for generic methods.">method</a>)simp_float, <span class="stringliteral">&quot;float&quot;</span>, <a class="code" href="group__atom.html#gga8aa6700e9f00b132eb376db6e39ade47a0b3aa0ab8104573dfc9cb70b5b08031f" title="32-bit float">A_FLOAT</a>, 0);
</pre></div><p>Then write the method that receives the floating-point value as follows:</p>
<div class="fragment"><pre class="fragment">    <span class="keywordtype">void</span> simp_float(t_simp *x, <span class="keywordtype">double</span> f)
    {
        <a class="code" href="group__console.html#ga8eebb1400d598f4423f925102d02970a" title="Print text to the Max window.">post</a>(<span class="stringliteral">&quot;got a float and it is %.2f&quot;</span>, f);
    }
</pre></div> </div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

		<div id="c74footer">
			&nbsp;&nbsp;Copyright &copy; 2011, <a href="http://www.cycling74.com/">Cycling '74</a>
		</div>
	</body>
</html>
