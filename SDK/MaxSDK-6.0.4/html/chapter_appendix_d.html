<!DOCTYPE html PUBLIC "-//W3C//DTD XHTML 1.0 Transitional//EN" "http://www.w3.org/TR/xhtml1/DTD/xhtml1-transitional.dtd">
<html xmlns="http://www.w3.org/1999/xhtml">
<head>
<meta http-equiv="Content-Type" content="text/xhtml;charset=UTF-8"/>
<title>Max 6 API</title>

<link href="tabs.css" rel="stylesheet" type="text/css"/>
<link href="doxygen.css" rel="stylesheet" type="text/css" />
<link href="navtree.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="jquery.js"></script>
<script type="text/javascript" src="resize.js"></script>
<script type="text/javascript" src="navtree.js"></script>
<script type="text/javascript">
  $(document).ready(initResizable);
</script>
<link href="search/search.css" rel="stylesheet" type="text/css"/>
<script type="text/javascript" src="search/search.js"></script>
<script type="text/javascript">
  $(document).ready(function() { searchBox.OnSelectItem(0); });
</script>

</head>
<body>
<div id="top"><!-- do not remove this div! -->


<div id="titlearea">
	<div id="c74header">
		<img src="header.png" height="200" />
	</div>
</div>

<!-- Generated by Doxygen 1.7.5.1 -->
<script type="text/javascript">
var searchBox = new SearchBox("searchBox", "search",false,'Search');
</script>
<script type="text/javascript" src="dynsections.js"></script>
  <div id="navrow1" class="tabs">
    <ul class="tablist">
      <li><a href="index.html"><span>Main&#160;Page</span></a></li>
      <li class="current"><a href="pages.html"><span>Related&#160;Pages</span></a></li>
      <li><a href="modules.html"><span>Modules</span></a></li>
      <li><a href="annotated.html"><span>Data&#160;Structures</span></a></li>
      <li>
        <div id="MSearchBox" class="MSearchBoxInactive">
        <span class="left">
          <img id="MSearchSelect" src="search/mag_sel.png"
               onmouseover="return searchBox.OnSearchSelectShow()"
               onmouseout="return searchBox.OnSearchSelectHide()"
               alt=""/>
          <input type="text" id="MSearchField" value="Search" accesskey="S"
               onfocus="searchBox.OnSearchFieldFocus(true)" 
               onblur="searchBox.OnSearchFieldFocus(false)" 
               onkeyup="searchBox.OnSearchFieldChange(event)"/>
          </span><span class="right">
            <a id="MSearchClose" href="javascript:searchBox.CloseResultsWindow()"><img id="MSearchCloseImg" border="0" src="search/close.png" alt=""/></a>
          </span>
        </div>
      </li>
    </ul>
  </div>
</div>
<div id="side-nav" class="ui-resizable side-nav-resizable">
  <div id="nav-tree">
    <div id="nav-tree-contents">
    </div>
  </div>
  <div id="splitbar" style="-moz-user-select:none;" 
       class="ui-resizable-handle">
  </div>
</div>
<script type="text/javascript">
  initNavTree('chapter_appendix_d.html','');
</script>
<div id="doc-content">
<div class="header">
  <div class="headertitle">
<div class="title">Appendix: Updating Externals for Max 6 </div>  </div>
</div>
<div class="contents">
<div class="textblock"><h2><a class="anchor" id="chapter_appendix_d_msp64"></a>
Updating MSP Externals for 64-bit Audio Processing</h2>
<h3><a class="anchor" id="chapter_appendix_d_background"></a>
Background</h3>
<p>In Max 5 and prior versions, the signal chain for processing audio was compiled by sending all objects in the patcher a "dsp" message. Objects responding to this message then executed their dsp method, typically adding one of the object's perform methods to the signal chain.</p>
<p>In Max 6, the signal chain is compiled by first sending objects a "dsp64" message. When your object responds to this message, you can add your 64-bit audio perform methods. If an object supports the old "dsp" message but not the "dsp64" message, it then wraps the older 32-bit perform routine with conversion on the inputs and outputs.</p>
<p>This means that the 64-bit engine will work just fine with the older 32-bit objects. However, the conversion comes with some computational expense. For the best performance your objects should support the 64-bit dsp chain natively by implementing the "dsp64" message as explained below.</p>
<h3><a class="anchor" id="chapter_appendix_d_api"></a>
API</h3>
<p>As noted, instead of the "dsp" method used by objects for Max 5 and earlier, Max 6 objects implement a "dsp64" method. This has the same purpose as the original dsp method. One notable difference is that the signals are not passed to the dsp64 method. This is to allow for the signal that is used to change dynamically at runtime. However, the relevant info (samplerate, number of signals connected, etc) is passed in.</p>
<p>The main purpose of the dsp64 method is to call back into the audio lib to put perform methods on the dsp chain. This is done by sending the 'dsp_add64' message to the dspchain object using <a class="el" href="group__obj.html#gae740749094827ac5adc2b7145db1c596" title="Sends an untyped message to an object.">object_method()</a>.</p>
<p>The perform routine is now of type t_perfroutine64, defined in z_dsp.h, and now has a fixed function signature. It does take a user-defined parameter that is passed back from the call to 'dsp_add64'.</p>
<h3><a class="anchor" id="chapter_appendix_d_examples"></a>
Example Code</h3>
<p>The simplemsp~ examples in the 'audio' folder of the SDK have been updated for 64-bit audio processing in Max 6. Several projects, including the simplemsp~ example, demonstrate how to support both 64-bit audio processing in Max 6 and 32-bit audio processing for compatibility with Max 5.</p>
<h2><a class="anchor" id="chapter_appendix_d_buffer"></a>
Buffer Access</h2>
<p>Enhancements have been made to the buffer~ object to both improve thread-safety and to simplify coding in your perform routine. You are very highly encouraged to update an externals accessing a buffer~ to use these enhancements.</p>
<p>To update an existing external, we assume that you have a <a class="el" href="structt__buffer.html" title="Data structure for the buffer~ object.">t_buffer</a> pointer named <code>b</code>. After obtaining a pointer to the buffer and assigning to <code>b</code>, the code in Max 5 would typically look like the following.</p>
<div class="fragment"><pre class="fragment">    <span class="keywordflow">if</span> (!b)
        <span class="keywordflow">goto</span> zero;

    <a class="code" href="group__threading.html#gafca49284437802927af64f9133765571" title="Use this routine for incrementing a global counter using a threadsafe and multiprocessor safe method...">ATOMIC_INCREMENT</a>(&amp;b-&gt;b_inuse);

    <span class="keywordflow">if</span> (!b-&gt;b_valid) {
        <a class="code" href="group__threading.html#gabd7677871ef0b04a3ca6e65aedd64dee" title="Use this routine for decrementing a global counter using a threadsafe and multiprocessor safe method...">ATOMIC_DECREMENT</a>(&amp;b-&gt;b_inuse);
        <span class="keywordflow">goto</span> zero;
    }
</pre></div><p>This code checks that there is a non-null pointer, uses a lightweight locking mechanism to lock the buffer~, then checks that the buffer~ is valid, and if not it "unlocks" the buffer and aborts. In Max 6, the following code will do perform the same functions and do so better than the Max 5 code above.</p>
<div class="fragment"><pre class="fragment">    <span class="keywordflow">if</span> (buffer_perform_begin(b) != <a class="code" href="group__misc.html#gga0764dd6c02b76cca7d053ae50555d69da6d22f77fef8b1e1b074cef5d29d935fd" title="No error.">MAX_ERR_NONE</a>)
        <span class="keywordflow">goto</span> zero;
</pre></div><p>After your perform routine is done with its buffer~ access you need to release the buffer's lock. In Max 5 that would be done as follows.</p>
<div class="fragment"><pre class="fragment">    <a class="code" href="group__threading.html#gabd7677871ef0b04a3ca6e65aedd64dee" title="Use this routine for decrementing a global counter using a threadsafe and multiprocessor safe method...">ATOMIC_DECREMENT</a>(&amp;b-&gt;b_inuse);
</pre></div><p>In Max 6, this should be replaced with this: </p>
<div class="fragment"><pre class="fragment">    buffer_perform_end(b);
</pre></div><p>You no longer need to include the "ext_atomic.h" header in your source code if you adopt these new buffer routines. The index~ example in the 'audio' folder of the SDK demonstrates the new routines for locking a buffer~ to access its memory.</p>
<h3><a class="anchor" id="chapter_appendix_d_buffer_precision"></a>
Buffer Precision</h3>
<p>While the Max 6 signal processing chain operates on 64-bit double-precision floats, the <a class="el" href="structt__buffer.html" title="Data structure for the buffer~ object.">t_buffer</a> storage remains as 32-bit single-precision float format. This is essential to maintain backward compatibility with older third-party externals.</p>
<p>Similarly several members of the <a class="el" href="structt__buffer.html" title="Data structure for the buffer~ object.">t_buffer</a> continue to be single precision floats to ensure a consistent struct size. This includes the following: </p>
<div class="fragment"><pre class="fragment">    <span class="keywordtype">float</span> b_1oversr;        <span class="comment">///&lt; 1 / sr</span>
<span class="comment"></span>    <span class="keywordtype">float</span> b_msr;            <span class="comment">///&lt; sr * .00</span>
</pre></div><p>If 32-bit accuracy of these values is insufficient, it is recommended that you calculate these yourself at double-precision.</p>
<h2><a class="anchor" id="chapter_appendix_d_cocoa"></a>
Updating Max Externals for Cocoa</h2>
<p>On the Macintosh platform, Max 6 made the transition from using the Carbon API to using the Cocoa API for interacting with the Mac OS. In most cases the transition for third-party developers should be seemless. If you are operating directly using native Carbon calls then your code will need to be updated to Cocoa using Objective-C.</p>
<p>The most common scenario is where you ask a patcherview for the native window handle with a call such as:</p>
<div class="fragment"><pre class="fragment">    WindowRef viewWindow;
    <a class="code" href="group__obj.html#gae740749094827ac5adc2b7145db1c596" title="Sends an untyped message to an object.">object_method</a>(patcherview, <a class="code" href="group__symbol.html#ga5d8db08b384aeb76eaee85a15f46fbcb" title="Given a C-string, fetch the matching t_symbol pointer from the symbol table, generating the symbol if...">gensym</a>(<span class="stringliteral">&quot;nativewindow&quot;</span>), (<span class="keywordtype">void</span>**)&amp;viewWindow);
</pre></div><p>In Max 6 this will not work because the returned 'viewWindow' is not the Carbon WindowRef but is instead a Cocoa NSWindow*. You may update your code to use Cocoa instead of Carbon, or you may wish to transition more slowly by continuing to use a WindowRef. Here is an example to assist in obtaining a WindowRef:</p>
<div class="fragment"><pre class="fragment">    NSView      *cocoa_view = NULL;
    NSWindow    *cocoa_window = NULL;
    WindowRef   carbon_window;
    
    <a class="code" href="group__obj.html#gae740749094827ac5adc2b7145db1c596" title="Sends an untyped message to an object.">object_method</a>(patcherview, <a class="code" href="group__symbol.html#ga5d8db08b384aeb76eaee85a15f46fbcb" title="Given a C-string, fetch the matching t_symbol pointer from the symbol table, generating the symbol if...">gensym</a>(<span class="stringliteral">&quot;nativewindow&quot;</span>), (<span class="keywordtype">void</span>**)&amp;cocoa_view);
    <span class="keywordflow">if</span> (cocoa_view) {
        cocoa_window = [cocoa_view window];
        <span class="keywordflow">if</span> (cocoa_window) {
            carbon_window = [cocoa_window windowRef];
        }
    }
    
    <span class="comment">// now you can use your carbon_window as before</span>
</pre></div> </div></div>
</div>
  <div id="nav-path" class="navpath">
    <ul>
<!-- window showing the filter options -->
<div id="MSearchSelectWindow"
     onmouseover="return searchBox.OnSearchSelectShow()"
     onmouseout="return searchBox.OnSearchSelectHide()"
     onkeydown="return searchBox.OnSearchSelectKey(event)">
<a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(0)"><span class="SelectionMark">&#160;</span>All</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(1)"><span class="SelectionMark">&#160;</span>Data Structures</a><a class="SelectItem" href="javascript:void(0)" onclick="searchBox.OnSelectItem(2)"><span class="SelectionMark">&#160;</span>Variables</a></div>

<!-- iframe showing the search results (closed by default) -->
<div id="MSearchResultsWindow">
<iframe src="javascript:void(0)" frameborder="0" 
        name="MSearchResults" id="MSearchResults">
</iframe>
</div>

		<div id="c74footer">
			&nbsp;&nbsp;Copyright &copy; 2011, <a href="http://www.cycling74.com/">Cycling '74</a>
		</div>
	</body>
</html>
